print("ðŸš€ EY !! Bro â€” Iniciando MÃ“DULO 6 (Cruce con Nota TÃ©cnica)")

import pandas as pd
import unicodedata
import re
from datetime import date
import datetime

# ====================================================
# 1. CONFIGURACIÃ“N DE ARCHIVOS
# ====================================================
archivo_entrada = r"C:\Users\alejandroar\Desktop\1. Capita\1. Sikuany - 830512772\6. Resultado Final\7. Julio 2025\05.Modulo_Capita_Julio_2025.xlsx"
df_principal = pd.read_excel(archivo_entrada, dtype=str, engine="openpyxl")

archivo_maestra = r"C:\Users\alejandroar\Desktop\1. Capita\1. Sikuany - 830512772\5. BD Fijas\0. Nota Tecnica\4.BD_Final_Nota_Tecnica.xlsx"
df_maestra = pd.read_excel(archivo_maestra, sheet_name="Hoja1", dtype=str, engine="openpyxl")

print("ðŸ“¥ Registros BD Principal:", len(df_principal))
print("ðŸ“¥ Registros Nota TÃ©cnica:", len(df_maestra))


# ====================================================
# 2. CREAR LLAVE "Llave NT" EN BD PRINCIPAL
# ====================================================
print("\nðŸ”‘ Creando Llave NT...")

df_principal["Codigo"] = df_principal["Codigo"].fillna("")
df_principal["cum_cod_atc"] = df_principal["cum_cod_atc"].fillna("")

df_principal["Llave NT"] = df_principal["Codigo"] + "_" + df_principal["cum_cod_atc"]

print("âœ” Llave NT creada correctamente")


# ====================================================
# 3. PREPARAR BD NOTA TÃ‰CNICA (DEDUP) ANTES DEL MERGE
# ====================================================
print("\nðŸ“Œ Verificando duplicados en la BD Nota TÃ©cnica...")

right_key = "LLAVE NOTA TECNICA"
cols_extraer = ["MODALIDAD", "COSTO MEDIO", "Q PROPIUESTA"]

# ValidaciÃ³n de columnas
if right_key not in df_maestra.columns:
    raise KeyError(f"âŒ No existe la columna '{right_key}' en Nota TÃ©cnica.")

for col in cols_extraer:
    if col not in df_maestra.columns:
        raise KeyError(f"âŒ Falta la columna '{col}' en Nota TÃ©cnica.")

# Conteo de duplicados
total_nt = len(df_maestra)
unique_nt = df_maestra[right_key].nunique(dropna=True)
dups_nt = total_nt - df_maestra.drop_duplicates(subset=[right_key]).shape[0]

print(f"   â†’ Filas totales: {total_nt:,}")
print(f"   â†’ Llaves Ãºnicas: {unique_nt:,}")
print(f"   â†’ Filas duplicadas por llave: {dups_nt:,}")

# âœ” Quitar duplicados por llave
df_nt_reducida = df_maestra.drop_duplicates(subset=[right_key], keep="first")[
    [right_key] + cols_extraer
].copy()

print("âœ” BD Nota TÃ©cnica reducida creada correctamente")
print("   â†’ Filas despuÃ©s de dedupe:", len(df_nt_reducida))


# ====================================================
# 4. MERGE EXACTO (SIN DUPLICAR FILAS)
# ====================================================
print("\nðŸ”— Realizando merge exacto Llave NT vs LLAVE NOTA TECNICA...")

before = len(df_principal)

df_merge = df_principal.merge(
    df_nt_reducida,
    how="left",
    left_on="Llave NT",
    right_on=right_key,
    sort=False,
    suffixes=("", "_NT")
)

after = len(df_merge)

print(f"âœ” Merge realizado")
print(f"   â†’ Filas antes : {before:,}")
print(f"   â†’ Filas despuÃ©s: {after:,}")

if before != after:
    print("âš  ALERTA: El merge estÃ¡ generando filas adicionales. ðŸ‘‡")
    mult = df_merge.groupby("Llave NT").size().loc[lambda x: x > 1]
    if not mult.empty:
        print("   â†’ Llaves que se multiplicaron (primeras 5):")
        print(mult.head(5))
else:
    print("âœ” El nÃºmero de filas se mantuvo. (OK)")


# ====================================================
# 5. RENOMBRAR COLUMNAS (SIN CREAR 'Q PROPIUESTA 2')
# ====================================================
df_merge.rename(columns={
    "MODALIDAD": "MODALIDAD",
    "COSTO MEDIO": "COSTO_MEDIO",
    "Q PROPIUESTA": "Q_PROPUESTA"
}, inplace=True)

print("\nðŸ“Œ Columnas agregadas al resultado final:")
print("   - MODALIDAD")
print("   - COSTO_MEDIO")
print("   - Q_PROPUESTA")


# ====================================================
# 6. EXPORTAR ARCHIVO FINAL
# ====================================================
salida = r"C:\Users\alejandroar\Desktop\1. Capita\1. Sikuany - 830512772\6. Resultado Final\7. Julio 2025\06.Modulo_Nota_Credito_Julio_2025.xlsx"
df_merge.to_excel(salida, index=False, engine="openpyxl")

print("\nðŸ’¾ Archivo exportado correctamente en:")
print(salida)

print("\nðŸš€ MÃ“DULO 6 FINALIZADO EXITOSAMENTE")
